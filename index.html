<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LaluLintasKu â€” Statistik & Laporan</title>
<style>
:root{
  --green:#007a1c;
  --green-dark:#005c15;
  --page-bg:#fff;
  --panel-bg: rgba(0,0,0,0.7);
}
body{
  margin:0; font-family: Inter, system-ui, Arial, sans-serif; background: var(--page-bg);
}
.header{
  background: var(--green); color:#fff; padding:12px 16px; position:relative; text-align:center;
}
.header .menu-btn{
  position:absolute; left:12px; top:8px; font-size:22px; cursor:pointer; transition: transform .25s;
}
.header .menu-btn.rotate{ transform: rotate(90deg); }
.header h1{ margin:0; font-size:20px; display:inline-block; vertical-align:middle; }
.sidebar{
  position:fixed; top:0; left:-250px; width:250px; height:100%; background:var(--panel-bg); padding-top:60px;
  transition:left .25s ease; z-index:2000;
}
.sidebar.active{ left:0; }
.sidebar a{ display:block; padding:12px 20px; color:#fff; text-decoration:none; font-size:15px; transition: background .2s; }
.sidebar a:hover, .sidebar a.active{ background: rgba(255,255,255,0.15); }
.main{ padding:24px; max-width:1000px; margin:24px auto; }
.card{ background:#fff; border-radius:16px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin:12px auto; text-align:center; }
.card h2, .card h3{ margin-top:0; margin-bottom:12px; color:#111; }
select, textarea, input[type="text"], input[type="file"]{
  width:92%; max-width:560px; padding:10px; border-radius:10px; border:1px solid #d0d0d0; font-size:15px; margin-bottom:10px;
}
textarea{ min-height:110px; resize:vertical; }
.btn{ margin-top:16px; background:var(--green); color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; }
.btn:hover{ background:var(--green-dark); }
.stats-card{ max-width:900px; margin:18px auto; padding:18px; border-radius:12px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.status-macet{ color:#d92727; font-weight:700; }
.status-gangguan{ color:#f0a500; font-weight:700; }
.status-kecelakaan{ color:#ff0000; font-weight:700; }
.muted{ color:#666; font-size:13px; margin-top:8px; }
.small{ font-size:13px; color:#444; }
@media(max-width:640px){ .card{ width:94%; padding:18px; } select,input,textarea{ width:100%; } .sidebar{ width:220px; } }
#logoSmall{ display:block; margin:20px auto; max-width:300px; height:auto; }
#chartContainer{ display:flex; flex-wrap:wrap; justify-content:center; align-items:flex-start; gap:20px; max-width:900px; margin:20px auto; }
#chartBox{ flex:1; min-width:300px; }
#chartInfo{ flex:1; min-width:200px; font-size:14px; background:#f7f7f7; padding:16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
#fotoPreview{ margin-top:10px; max-width:200px; border-radius:10px; }
</style>
</head>
<body>

<header class="header">
  <span class="menu-btn" id="menuBtn">â˜°</span>
  <h1>ðŸš¦ LaluLintasKu</h1>
</header>
<img src="logo.png" alt="Logo" id="logoSmall">

<nav class="sidebar" id="sidebar">
  <a href="#" data-target="statistikSection" class="active">ðŸ“Š Statistik</a>
  <a href="#" data-target="kameraSection">ðŸ“· Statistik Kamera</a>
  <a href="#" data-target="laporanSection">ðŸ“‹ Laporan</a>
  <a href="#" data-target="amanSection">ðŸš— Cara Mengemudi Aman</a>
  <a href="#" data-target="loginSection">ðŸ”‘ Login</a>
</nav>

<main class="main">

<section id="statistikSection" class="stats-card">
  <h3>ðŸ“Š Statistik Laporan (â‰¤ 1 jam)</h3>
  <div style="margin-bottom:12px;">
    <label for="filterProv">Provinsi:</label>
    <select id="filterProv"><option value="">-- Pilih Provinsi --</option><option value="Jawa Timur">Jawa Timur</option><option value="Jawa Barat">Jawa Barat</option><option value="DKI Jakarta">DKI Jakarta</option></select>
    <label for="filterKota">Kota:</label>
    <select id="filterKota"><option value="">-- Pilih Kota --</option></select>
    <label for="filterDaerah">Daerah:</label>
    <select id="filterDaerah"><option value="">-- Pilih Daerah --</option></select>
  </div>
  <div id="chartContainer">
    <div id="chartBox"><canvas id="chart"></canvas></div>
    <div id="chartInfo">Belum ada laporan.</div>
  </div>
</section>

<section id="kameraSection" class="stats-card" style="display:none;">
  <h3>ðŸ“· Statistik dari Kamera</h3>
  <div id="kameraInfo">Menunggu data kamera...</div>
</section>

<section id="laporanSection" class="card" style="display:none;">
  <h2>Laporan Lalu Lintas</h2>
  <!-- ... isi form laporan tetap sama ... -->
</section>

<section id="amanSection" class="card" style="display:none;">
  <h3>Cara Mengemudi Aman</h3>
  <ul style="text-align:left;">
    <li>Roda 2: Gunakan helm, patuhi rambu, jaga jarak.</li>
    <li>Roda 4: Pakai sabuk pengaman, jangan pakai HP saat mengemudi.</li>
    <li>Truck: Periksa muatan, patuhi batas kecepatan, gunakan lampu tambahan.</li>
  </ul>
</section>

<section id="loginSection" class="card" style="display:none;">
  <h3>Login (Sementara)</h3>
  <p class="small">Demo akun tunggal.</p>
</section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVHQKQ3iAGWPepnd_DuoGQmpxG40i8uMs",
  authDomain: "laporan-lalu-lintas.firebaseapp.com",
  databaseURL: "https://laporan-lalu-lintas-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-lalu-lintas",
  storageBucket: "laporan-lalu-lintas.appspot.com",
  messagingSenderId: "706382913725",
  appId: "1:706382913725:web:1069a4f53bea6b66a357d4"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// Sidebar toggle
const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');
menuBtn.addEventListener('click', ()=>{ sidebar.classList.toggle('active'); menuBtn.classList.toggle('rotate'); });
sidebar.querySelectorAll('a[data-target]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    const target = a.dataset.target;
    document.querySelectorAll('main section').forEach(s=>s.style.display='none');
    document.getElementById(target).style.display='block';
    sidebar.classList.remove('active'); menuBtn.classList.remove('rotate');
    sidebar.querySelectorAll('a').forEach(link=>link.classList.remove('active'));
    a.classList.add('active');
  });
});

// Statistik dari Kamera
const kameraInfo = document.getElementById("kameraInfo");
onValue(ref(db, "traffic/status"), snapshot => {
  const data = snapshot.val();
  if(data){
    kameraInfo.innerHTML = `
      <div style="text-align:left; line-height:1.6;">
        <div><b>Status:</b> ${data.status.toUpperCase()}</div>
        <div><b>Jumlah Kendaraan:</b> ${data.vehicle_count}</div>
        <div><b>Update:</b> ${new Date().toLocaleTimeString()}</div>
      </div>
    `;
  } else {
    kameraInfo.textContent = "Belum ada data dari kamera.";
  }
});

// Statistik Chart.js
const ctx = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx, {type:'bar', data:{labels:['Macet','Gangguan Lalu Lintas','Kecelakaan'], datasets:[{label:'Jumlah Laporan',data:[0,0,0],backgroundColor:['#d92727','#f0a500','#ff0000']}]}, options:{responsive:true,plugins:{legend:{display:false}}}});

const filterProv = document.getElementById('filterProv');
const filterKota = document.getElementById('filterKota');
const filterDaerah = document.getElementById('filterDaerah');

filterProv.addEventListener('change', ()=>{ updateChart(); });
filterKota.addEventListener('change', ()=>{ updateChart(); });
filterDaerah.addEventListener('change', ()=>{ updateChart(); });

function updateChart(){
  if(!filterProv.value || !filterKota.value || !filterDaerah.value) {
    document.getElementById('chartInfo').innerText='Pilih Provinsi, Kota, dan Daerah terlebih dahulu';
    return;
  }
  onValue(ref(db,'laporan'), snapshot=>{
    const data = snapshot.val() || {};
    const now = Date.now();
    const laporanArr = Object.values(data).filter(l=> now - l.waktu < 3600000 );
    const counts={'Macet':0,'Gangguan Lalu Lintas':0,'Kecelakaan':0};
    laporanArr.forEach(l=>{
      if(l.provinsi!==filterProv.value || l.kota!==filterKota.value || l.daerah!==filterDaerah.value) return;
      if(counts[l.status]!==undefined) counts[l.status]++;
    });
    chart.data.datasets[0].data = [counts['Macet'], counts['Gangguan Lalu Lintas'], counts['Kecelakaan']];
    chart.update();
    const total=Object.values(counts).reduce((a,b)=>a+b,0);
    let mayoritas='Belum ada laporan';
    let alasan='';
    if(total>0){
      const max=Math.max(...Object.values(counts));
      const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0);
      mayoritas=winners.length===1?winners[0]:'Seimbang';
      alasan=`Jumlah laporan terbanyak di kategori "${mayoritas}"`;
    }
    document.getElementById('chartInfo').innerHTML=`
      <div style="text-align:left; line-height:1.6;">
        <div><b>Total laporan:</b> ${total}</div>
        <div class="status-macet">Macet: <b>${counts['Macet']}</b></div>
        <div class="status-gangguan">Gangguan: <b>${counts['Gangguan Lalu Lintas']}</b></div>
        <div class="status-kecelakaan">Kecelakaan: <b>${counts['Kecelakaan']}</b></div>
        <hr>
        <div><b>Mayoritas:</b> ${mayoritas}</div>
        <div><b>Alasan:</b> ${alasan}</div>
      </div>
    `;
  });
}
updateChart();
</script>
</body>
</html>
